# Discord VC画面共有催促機能 仕様書

## 1. 概要

DiscordのVCチャンネルにおいて、一定人数以上が参加している状態で一定時間経過後、画面共有をしているメンバーが少ない場合に画面共有を促すメッセージを送信する機能を追加する。

## 2. 機能要件

### 2.1 基本動作

- VCチャンネルに**N人以上**のユーザーが参加している状態を監視
- 参加から**M分以上**経過した場合に画面共有状態をチェック
- 画面共有しているユーザーが**O人未満**の場合、催促メッセージを送信

### 2.2 設定項目

設定ファイル（`config.toml`）に以下のセクションとパラメータを追加：

```toml
# === 共通設定 ===
# サーバーID
guild_ids = ["1006251837210501190"]

# 催促対象のVCカテゴリID
vc_category_ids = ["1006251838028398593"]

# 催促から除外するVCチャンネルID
exclude_vc_channel_ids = ["1006410143925280799"]

# === ステータスメッセージ設定 ===
[status_message]
# ステータスメッセージをつけるべき人数
num_user_to_describe = 1

# ステータスメッセージを設定するべき時間 (分)
minute_to_set_status = 10

# ステータスメッセージを変更するべき時間 (分)
minute_to_modify_status = 60

# === 画面共有設定 ===
[screen_share]
# 画面共有催促をするべき最小人数
min_users_for_prompt = 3

# 画面共有催促をするまでの時間 (分)
minute_to_prompt = 15

# 必要な画面共有人数の閾値
min_screen_share_users = 1
```

### 2.3 催促メッセージ

```
画面共有をして、自分のゲームや作業をみんなに見せてみよう！
-# VC外からも画面共有のプレビューが見れます。VCに来てくれる人が増えるかも？
```

※催促は1回のみ実施（再催促なし）

## 3. 技術仕様

### 3.1 画面共有状態の検出

Discord.jsの`VoiceState`オブジェクトから以下の情報を取得：
- `streaming`: 画面共有中かどうか

画面共有カウント = `streaming`が`true`のメンバー数

### 3.2 実装場所

- **メインロジック**: `src/voice_handler.ts`の`updateVoiceChannel`関数を拡張
- **設定管理**: `src/utils/config.ts`に新規セクション（`status_message`と`screen_share`）を追加
- **ジョブ管理**: 既存の`vcStatus`に画面共有催促用のジョブを追加

### 3.3 処理フロー

1. VCチャンネルの人数が`screen_share.min_users_for_prompt`以上 かつ 画面共有人数が`screen_share.min_screen_share_users`未満の場合、監視開始
2. `screen_share.minute_to_prompt`分後に催促メッセージを送信
3. メッセージ送信後、ジョブを削除（催促は1回のみ）
4. 条件を満たさなくなった場合（人数減少 or 画面共有開始）：
   - ジョブをキャンセル

### 3.4 イベントハンドリング

以下のイベントで画面共有状態を再評価：
- `VoiceStateUpdate`: ユーザーの入退室、画面共有状態の変更
- 既存のステータス更新と同様の処理フロー

## 4. 除外条件

以下の場合は催促を行わない：
- 設定で除外されたVCチャンネル（`exclude_vc_channel_ids`）
- 催促対象外のカテゴリ（`vc_category_ids`に含まれないカテゴリ）
- VC参加人数が`screen_share.min_users_for_prompt`未満 or 画面共有人数が`screen_share.min_screen_share_users`以上

## 5. UI/UX考慮事項

- メッセージは控えめで、押し付けがましくない文言を使用
- 既存のステータス催促メッセージと同じチャンネルに送信
- メンションは使用しない（`allowedMentions: { users: [] }`）
- ボタンコンポーネントは追加しない（画面共有はDiscordクライアントから直接操作）

## 6. 実装のポイント

- **シンプルな仕様**: 再催促なし、1回のみの催促でユーザーに負担をかけない
- **リアルタイム監視**: VoiceStateUpdateで画面共有状態の変更を即座に検出
- **条件の統合**: 人数チェックと画面共有チェックを同一条件で実行し、コードを簡素化
- **適切なジョブ管理**: 条件を満たさなくなった場合の自動的なジョブキャンセル

## 7. 今後の拡張可能性

- 時間帯による催促の有効/無効切り替え
- VCチャンネルごとの個別設定
- 画面共有の種類（アプリケーション/画面全体）による判定
- 催促メッセージのカスタマイズ機能